{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "NarratorOutput",
  "type": "object",
  "required": ["final_text", "next_prompt", "suggested_actions"],
  "properties": {
    "final_text": {"type": "string"},
    "next_prompt": {"type": "string"},
    "suggested_actions": {
      "type": "array",
      "items": {"type": "string"}
    },
    "established_facts": {
      "type": "array",
      "description": "New narrative details introduced that should persist across turns",
      "items": {
        "type": "object",
        "required": ["subject", "detail"],
        "properties": {
          "subject": {
            "type": "string",
            "description": "Entity ID or 'scene' this fact is about"
          },
          "detail": {
            "type": "string",
            "description": "The narrative detail to remember"
          }
        },
        "additionalProperties": false
      }
    },
    "introduced_items": {
      "type": "array",
      "description": "Tangible items introduced by narration that should become real game objects",
      "items": {
        "type": "object",
        "required": ["name", "description", "narrative_role"],
        "properties": {
          "name": {
            "type": "string",
            "description": "Short item name (e.g. 'Data Chip', 'Stim Patch')"
          },
          "description": {
            "type": "string",
            "description": "Brief in-world description"
          },
          "narrative_role": {
            "type": "string",
            "description": "Why this item matters to the story",
            "enum": ["clue", "tool", "flavor", "resource"]
          },
          "found_on": {
            "type": "string",
            "description": "Entity ID this was found on/in, if applicable"
          }
        },
        "additionalProperties": false
      }
    },
    "scene_transition": {
      "type": ["object", "null"],
      "description": "Declare when the player has physically moved to a new location",
      "properties": {
        "location_id": {
          "type": "string",
          "description": "Kebab-case ID for the location (e.g. 'merchant-quarter', 'taxi-cab')"
        },
        "location_name": {
          "type": "string",
          "description": "Human-readable location name"
        },
        "description": {
          "type": "string",
          "description": "Brief orienting description of the new location"
        },
        "present_entities": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Entity IDs present in the new scene (always include 'player')"
        }
      },
      "required": ["location_id", "location_name", "present_entities"]
    },
    "introduced_npcs": {
      "type": "array",
      "description": "NPCs introduced by narration that should become tracked game entities",
      "items": {
        "type": "object",
        "required": ["entity_id", "name", "description"],
        "properties": {
          "entity_id": {
            "type": "string",
            "description": "Kebab-case entity ID (e.g. 'taxi-driver', 'dock-worker')"
          },
          "name": {
            "type": "string",
            "description": "NPC display name (e.g. 'Renzo', 'Dock Worker')"
          },
          "description": {
            "type": "string",
            "description": "Brief in-world description"
          },
          "role": {
            "type": "string",
            "description": "Narrative role (e.g. 'witness', 'obstacle', 'contact')"
          }
        },
        "additionalProperties": false
      }
    },
    "thread_updates": {
      "type": "array",
      "description": "Thread status changes declared by narration",
      "items": {
        "type": "object",
        "required": ["thread_id", "status"],
        "properties": {
          "thread_id": {
            "type": "string",
            "description": "ID of the thread to update"
          },
          "status": {
            "type": "string",
            "description": "New thread status",
            "enum": ["active", "stalled", "resolved", "failed"]
          },
          "reason": {
            "type": "string",
            "description": "Why the thread status changed"
          }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false
}
